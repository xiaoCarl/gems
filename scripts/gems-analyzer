#!/bin/bash
#
# gems-analyzer - AIä»·å€¼æŠ•èµ„åˆ†æå·¥å…·å…¥å£
# ç”¨æ³•: gems-analyzer [è‚¡ç¥¨ä»£ç |é€‰é¡¹]
#

set -e

# é¡¹ç›®è·¯å¾„ï¼ˆå½“å‰ç›®å½•ï¼‰
PROJECT_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

echo "ğŸ”® Gems Analyzer - AIä»·å€¼æŠ•èµ„åˆ†æå·¥å…·"
echo ""

# æ£€æŸ¥Pythonç¯å¢ƒ
if ! command -v python3 &> /dev/null; then
    echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° Python3"
    exit 1
fi

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    if ! python3 -c "import gems" 2>/dev/null; then
        echo "ğŸ“¦ æ­£åœ¨å®‰è£…ä¾èµ–..."
        if [ -f "$PROJECT_PATH/pyproject.toml" ]; then
            if command -v uv &> /dev/null; then
                (cd "$PROJECT_PATH" && uv sync)
            else
                (cd "$PROJECT_PATH" && pip install -e . -q)
            fi
        fi
    fi
}

# æ£€æŸ¥.envæ–‡ä»¶
check_env() {
    if [ ! -f "$PROJECT_PATH/.env" ]; then
        echo "âš ï¸  è­¦å‘Šï¼š.envæ–‡ä»¶ä¸å­˜åœ¨"
        echo ""
        echo "è¯·åˆ›å»º $PROJECT_PATH/.env æ–‡ä»¶å¹¶é…ç½®APIå¯†é’¥ï¼š"
        echo ""
        echo "# DeepSeek APIï¼ˆæ¨èï¼‰"
        echo "DEEPSEEK_API_KEY=your-deepseek-api-key"
        echo ""
        echo "# æˆ– Qwen API"
        echo "USE_QWEN=true"
        echo "DASHSCOPE_API_KEY=your-dashscope-api-key"
        echo ""
        return 1
    fi
    return 0
}

# è§£æå‚æ•°
if [ $# -eq 0 ]; then
    # æ— å‚æ•°ï¼Œæ˜¾ç¤ºå¸®åŠ©
    echo "ç”¨æ³•:"
    echo "  gems-analyzer 600519           # åˆ†æè´µå·èŒ…å°"
    echo "  gems-analyzer 00700.HK         # åˆ†æè…¾è®¯æ§è‚¡"
    echo "  gems-analyzer 600519 --json    # è¾“å‡ºJSONæ ¼å¼"
    echo "  gems-analyzer 600519 --force   # å¼ºåˆ¶é‡æ–°åˆ†æ"
    echo "  gems-analyzer --search èŒ…å°    # æœç´¢è‚¡ç¥¨ä»£ç "
    echo "  gems-analyzer --interactive    # äº¤äº’å¼åˆ†ææ¨¡å¼"
    echo "  gems-analyzer --batch 600519 00700.HK  # æ‰¹é‡åˆ†æ"
    echo "  gems-analyzer --help           # æ˜¾ç¤ºå®Œæ•´å¸®åŠ©"
    exit 0
fi

# æ£€æŸ¥ä¾èµ–
check_dependencies

# å¤„ç†é€‰é¡¹
case "$1" in
    --search|-s)
        if [ -z "$2" ]; then
            echo "âŒ é”™è¯¯ï¼šè¯·æä¾›æœç´¢å…³é”®è¯"
            echo "  ç¤ºä¾‹: gems-analyzer --search èŒ…å°"
            exit 1
        fi
        python3 "$PROJECT_PATH/scripts/search_stock.py" "$2"
        ;;
    --interactive|-i)
        check_env || exit 1
        echo "ğŸš€ å¯åŠ¨äº¤äº’å¼åˆ†ææ¨¡å¼..."
        cd "$PROJECT_PATH"
        python3 -c "
import sys
sys.path.insert(0, 'src')
from gems.cli import main
main()
"
        ;;
    --batch|-b)
        shift
        check_env || exit 1
        python3 "$PROJECT_PATH/scripts/batch_analyze.py" "$@"
        ;;
    --version|-v)
        echo "gems-analyzer 2.0.0"
        ;;
    --help|-h)
        python3 "$PROJECT_PATH/scripts/analyze_stock.py" --help
        ;;
    *)
        # é»˜è®¤ï¼šåˆ†æè‚¡ç¥¨
        check_env || exit 1
        python3 "$PROJECT_PATH/scripts/analyze_stock.py" "$@"
        ;;
esac
